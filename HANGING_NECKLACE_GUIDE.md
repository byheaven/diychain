# 🌍 悬挂项链物理系统

## 📋 设计理念

完全基于物理模拟的悬挂项链系统，无需手动布局。

### 核心特性

✅ **两个固定锚点** - 模拟挂在墙上的两个钉子（左右肩膀位置）
✅ **真实重力** - 9.81 m/s² 向下，珠子自然下垂
✅ **球形关节** - 珠子之间通过关节连接，形成柔性链条
✅ **动态平衡** - 添加珠子后，链条自动调整形状
✅ **可视化链绳** - 银色线实时跟随珠子位置

---

## 🎯 工作原理

### 坐标系统

```
       Y (上)
       ↑
       |
   ●---|---●  ← 固定锚点（金色球）
    \     /
     \   /
      \ /
       ●      ← 珠子受重力下坠
       ●
       ●
       
←------+------→ X (左右)
       
       ⊙ Z (深度，进出屏幕)
```

### 物理连接

```
左锚点 ━━ 珠子1 ━━ 珠子2 ━━ 珠子3 ━━ 右锚点
  (固定)    ↓        ↓        ↓      (固定)
          关节      关节      关节
```

---

## 🔧 关键参数

### 固定锚点位置

```typescript
const leftAnchor = new THREE.Vector3(-2, 3, 0)   // 左侧锚点
const rightAnchor = new THREE.Vector3(2, 3, 0)   // 右侧锚点
```

**调整方法：**
- 增大 X 值 (`±3`) - 锚点更宽，项链更平
- 减小 X 值 (`±1.5`) - 锚点更窄，项链更下垂
- 调整 Y 值 - 改变悬挂高度

### 重力强度

```typescript
<Physics gravity={[0, -9.81, 0]}>
```

**调整：**
- `-9.81` - 标准地球重力
- `-4.9` - 月球重力（慢动作效果）
- `-19.6` - 双倍重力（快速下落）

### 珠子物理属性

```typescript
mass: beadMass          // 质量（从 catalog weightG 转换）
linearDamping: 1.5      // 线性阻尼（抑制晃动）
angularDamping: 1.5     // 旋转阻尼
friction: 0.9           // 摩擦力
restitution: 0.05       // 弹性（低值 = 不弹）
```

---

## 📐 初始位置算法

### Catenary 曲线（悬链线）

珠子初始排列成抛物线形状：

```typescript
const t = index / (total - 1)  // 0 到 1
const x = lerp(leftX, rightX, t)
const y = startY - centerDrop * sin(t * π)
```

**参数：**
- `centerDrop = 1.5` - 中心下垂幅度（增大 = 更下垂）
- 起始 Y = 3.0 - 悬挂高度

---

## 🎨 视觉元素

### 1. 金色锚点
- 直径：0.08 单位
- 颜色：#FFD700（金色）
- 材质：金属光泽

### 2. 银色链绳
- 颜色：#C0C0C0（银色）
- 实时跟随珠子位置
- 连接：左锚点 → 珠子1 → 珠子2 → ... → 右锚点

### 3. 珠子
- 自动缩放到合适大小
- 碰撞体基于实际尺寸
- 质量基于 catalog 配置

---

## 🚀 使用方法

### 添加珠子

1. 拖拽珠子到画布
2. 珠子自动添加到链条末端
3. 重力立即生效，链条重新调整形状
4. 等待 1-2 秒物理稳定

### 观察效果

- **少量珠子（1-5）**：轻微下垂
- **中等数量（6-12）**：明显的 U 形曲线
- **大量珠子（15+）**：深度下垂，接近 V 形

### 移除珠子

- 删除珠子后，链条自动回弹到新的平衡位置

---

## 🐛 故障排查

### 问题1：珠子掉下去消失了

**原因：** 关节未正确连接

**检查控制台：**
```
[Hanging Chain] Bodies ready: 12/12
[Hanging Chain] ✅ All bodies ready, creating joints
```

**解决：**
- 确保 `bodiesReady` 为 `true`
- 检查所有 `rigidBodyRefs` 是否非空

### 问题2：链条太松/太紧

**调整阻尼：**
```typescript
linearDamping: 1.5  // 增加 = 更快稳定，减少 = 更多晃动
```

**调整初始下垂：**
```typescript
const centerDrop = 1.5  // 增加 = 更深的 U 形
```

### 问题3：珠子之间距离太远

**减小关节锚点偏移：**
```typescript
anchor1={[0, -0.05, 0]}  // 减小到 -0.05
anchor2={[0, 0.05, 0]}
```

### 问题4：性能问题

**减少物理步进频率（可选）：**
```typescript
<Physics 
  gravity={[0, -9.81, 0]} 
  timeStep={1/30}  // 30 FPS 物理更新
>
```

---

## 📊 性能数据

| 珠子数量 | FPS | 物理稳定时间 |
|---------|-----|------------|
| 5 颗 | 60 | ~1 秒 |
| 10 颗 | 55-60 | ~2 秒 |
| 20 颗 | 45-50 | ~3 秒 |
| 30 颗 | 35-40 | ~5 秒 |

**推荐：** 15-25 颗珠子是最佳体验

---

## 🎯 预期效果

### 空状态（0 珠子）
```
●━━━━━━━━━━━━━━━━━━━●
左锚点              右锚点
```

### 3 个珠子
```
●━━━━━━━━━━━━━━━━━━━●
  \       ●       /
   \     ● ●     /
    \___/ | \___/
```

### 12 个珠子
```
●━━━━━━━━━━━━━━━━━━━●
 \                 /
  \       ●       /
   \     ● ●     /
    \   ●   ●   /
     \ ●     ● /
      ●       ●
```

---

## 🔍 调试技巧

### 启用物理调试可视化

编辑 `src/components/editor/canvas-3d.tsx`：

```typescript
<Physics gravity={[0, -9.81, 0]} debug={true}>
```

会显示：
- 🟢 绿色线框 = 碰撞体
- 🔴 红色点 = 关节位置
- 🔵 蓝色箭头 = 力的方向

### 查看珠子质量

控制台会显示每个珠子的创建信息：
```
[Physics] Body 0 created at Vector3 {x: -2, y: 3, z: 0}
```

---

## ✨ 未来扩展

### 可交互拖拽
```typescript
<RigidBody 
  type="dynamic"
  onPointerDown={(e) => startDrag(e)}
>
```

### 风力效果
```typescript
<Physics gravity={[0.5, -9.81, 0]}>  // X 方向加入风力
```

### 项链佩戴模拟
- 添加颈部曲面碰撞体
- 珠子贴合颈部弧度

---

**创建时间：** 2025-11-11  
**版本：** 1.0 - Pure Physics

